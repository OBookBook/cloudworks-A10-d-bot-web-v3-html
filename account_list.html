<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€è¦§</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/admin-dashboard.css" />
</head>
<body>
    <div class="layout">
<!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="sidebar">
  <h2>è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
  <!-- ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <!-- <a href="tweet_japanese.html">æ—¥æœ¬äººã„ã„ã­</a> -->
  <!-- <a href="./tweet_japanese.html">Twitteræ‹¡æ•£ã‚µãƒ¼ãƒ“ã‚¹(æ—¥æœ¬äººã„ã„ã­)</a> -->
  <a href="./tweet_sensyuken.html">é¸æ‰‹æ¨©ã„ã„ã­</a>
  <a href="./tweet.html">ã„ã„ã­ãƒ»ï¾Œï¾ï½¯ï½¸ï¾ï½°ï½¸</a>
  <a href="./account_list.html">Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€è¦§</a>
  <a href="./account_regist.html">Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²</a>
  <a href="./account_regist2.html">Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²(è²¸å‡º)</a>
  <a href="./password.html">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</a>
  <a href="./upload.html">å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
  <a href="./upload.html">ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
  <a href="./user_master.html">AI APIè¨­å®š</a>
  <a href="./user_list.html">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†(ç®¡ç†è€…)</a>
  <a href="./login.html">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
</div>

   <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
   <div class="content" id="content">

    <h2>Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€è¦§</h2>
    <form method="GET" style="margin-bottom: 20px;">
        <input type="text" name="search" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§çµã‚Šè¾¼ã¿" value="<?php echo isset($_GET['search']) ? htmlspecialchars($_GET['search']) : ''; ?>">
        <button type="submit">æ¤œç´¢</button>
    </form>

    <div style="display: flex; align-items: center; gap: 10px;">
    <span>ãƒã‚§ãƒƒã‚¯ONã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—</span>

    <form method="GET" action="?" style="margin: 0; display: inline-block;">

        <select id="command_option" name="command" onchange="toggleCommandSource()">
            <option value="post">ï¾ï¾Ÿï½½ï¾„ï½ºï¾’ï¾ï¾„</option>
            <option value="reply">ï¾˜ï¾Œï¾Ÿï¾—ï½²ï½ºï¾’ï¾ï¾„</option>
            <option value="replytoreply">ï¾˜ï¾Œï¾Ÿtoï¾˜ï¾Œï¾Ÿï½ºï¾’ï¾ï¾„</option>

            <?php if (isset($_SESSION['check_enable']) && $_SESSION['check_enable'] == 1): ?>
            <option value="search">ç›£è¦–ãƒªãƒ—,ãƒ¢ãƒãƒãƒ</option>

            <!-- è²¸å‡ºã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ä¸€æ‹¬åˆ‡ã‚Šæ›¿ãˆãŒã§ãã¦ã—ã¾ã†ãŸã‚ä¿ç•™ -->
<!--            <option value="searchFrom">ç›£è¦–å®Ÿæ–½</option>  -->

            <?php endif; ?>

        </select>
    </form>

    <span>ã‚’</span>

    <div id="action1_source" style="margin-left: 10px;">
    <form method="GET" action="?" style="margin: 0; display: inline-block;">
    <select id="action1_option" name="action1" onchange="toggleDuplicateSource()">
        <option value="duplicate">è¤‡è£½ã™ã‚‹</option>
        <option value="delete">å‰Šé™¤ã™ã‚‹</option>
    </select>
    </div>

    <div id="action2_source" style="display: none; margin-left: 10px;">
    <form method="GET" action="?" style="margin: 0; display: inline-block;">
    <select id="action2_option" name="action2" >
        <option value="on">ONã«ã™ã‚‹</option>
        <option value="off">OFFã«ã™ã‚‹</option>
    </select>
    </div>

</form>

    <div id="duplicate_source" style="display: none; margin-left: 10px; display: inline-flex; align-items: center; gap: 12px; white-space: nowrap;">
    <span>(è¤‡è£½å…ƒï¼š</span>
    <select id="form_account_id" name="xuser" style="min-width: 120px;">
        <option value="">æœªé¸æŠ</option>
        <?php foreach ($xusers as $k => $row) { ?>
            <option value="<?php echo e($row['id']) ?>"
              <?php echo ( (string)$row['id'] === (string)$xuser_id ? 'selected' : '' ); ?>
              <?php echo e($row['name']) ?>
            </option>
        <?php } ?>
    </select>
    <span>)</span>
    </div>

    <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
    <button type="submit" onclick="executeAction()" style="margin-left: 10px;">å®Ÿè¡Œ</button>

    <script>
    function toggleDuplicateSource() {
        const actionOption = document.getElementById('action1_option');
        const duplicateSource = document.getElementById('duplicate_source');
        if (actionOption.value === "duplicate") {
            // è¤‡è£½ã™ã‚‹ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
            duplicateSource.style.display = "inline-flex";
        } else {
            // ãã®ä»–ã®å ´åˆ
            duplicateSource.style.display = "none";
        }
    }

    function toggleCommandSource() {
        const commandOption = document.getElementById('command_option');
        const action1Source = document.getElementById('action1_source');
        const action2Source = document.getElementById('action2_source');
        if (commandOption.value === "searchFrom") {
            // ç›£è¦–å®Ÿæ–½ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
            action1Source.style.display = "none";
            action2Source.style.display = "inline-block";
        } else {
            // ãã®ä»–ã®å ´åˆ
            action1Source.style.display = "inline-block";
            action2Source.style.display = "none";
        }

        toggleDuplicateSource();
    }
    function executeAction() {
        // ãƒ•ã‚©ãƒ¼ãƒ ã®è¦ç´ ã‚’å–å¾—
        const command = document.getElementById('command_option').value;
        const action1 = document.getElementById('action1_option').value;
        const action2 = document.getElementById('action2_option').value;
        const form_account_id = document.getElementById('form_account_id').value;

        // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸIDã‚’å–å¾—
        const selectedIds = Array.from(document.querySelectorAll('input[name="selected_ids[]"]:checked'))
            .map(checkbox => checkbox.value);

    // ç›£è¦–å®Ÿæ–½ãƒ¢ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
    if (command === "searchFrom") {
        const hasInvalidId = selectedIds.some(id => {
            alert("ã‚¨ãƒ©ãƒ¼: 1");
            const option = document.querySelector(`#form_account_id option[value="${id}"]`);
            alert("ã‚¨ãƒ©ãƒ¼: 2");
            return option && option.dataset.useAdminApi !== "0"; // use_admin_api ãŒ 0 ã˜ã‚ƒãªã„ã‚‚ã®ãŒã‚ã‚‹ã‹
        });

        if (hasInvalidId) {
            alert(hasInvalidId)
            alert('ã‚¨ãƒ©ãƒ¼: ç›£è¦–å®Ÿæ–½ãƒ¢ãƒ¼ãƒ‰ã¯ã€use_admin_api=0 ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿å®Ÿè¡Œã§ãã¾ã™ã€‚');
            return;
        }
//        alert("ã‚¨ãƒ©ãƒ¼: ç›£è¦–å®Ÿæ–½ãƒ¢ãƒ¼ãƒ‰ã¯é¸æŠã§ãã¾ã›ã‚“ã€‚");
  //      return;
    }

    if (selectedIds.length === 0) {
        alert("ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }

//        alert(command);
//        alert(action1);
//        alert(action2);
//        alert(selectedIds);
//        alert(form_account_id);

        // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        fetch('account_process.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                command: command,
                action1: action1,
                action2: action2,
                selected_ids: selectedIds,
                form_account_id : form_account_id,
            }),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message); // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            window.location.reload(); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        })
        .catch(error => {
            console.error('ã‚¨ãƒ©ãƒ¼:', error);
        });
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    document.addEventListener('DOMContentLoaded', toggleDuplicateSource);
    </script>

<script>

document.addEventListener("DOMContentLoaded", function () {
    toggleUseAdminApi();
});

function toggleUseAdminApi() {


    const searchOptions = document.getElementById('search-options');
    const processOptions = document.getElementById('process-options');
    const selectedMode = document.querySelector('input[name="new_use_admin_api"]:checked').value;

    if (selectedMode === "search") {
        searchOptions.style.display = "block";
        processOptions.style.display = "none";
    } else {
        searchOptions.style.display = "none";
        processOptions.style.display = "block";
    }

//    if (isset($_SESSION['api_master_id']) && $_SESSION['api_master_id'] === 0)

    // PHPã‹ã‚‰å–å¾—ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ã‚’JavaScriptã«æ¸¡ã™
    const apiMasterId = <?php echo json_encode($api_master_id); ?>;
    if (apiMasterId === 0)
    {
//        searchOptions.style.display = "block";
//        processOptions.style.display = "block";
    }

}

function toggleMenu(menuEl) {
  // ä»–ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
  document.querySelectorAll('.dropdown-menu').forEach(el => {
    if (el !== menuEl) {
      el.classList.remove('show');
      el.classList.remove('show-above');
    }
  });

  // è¡¨ç¤ºãƒˆã‚°ãƒ«
  const isVisible = menuEl.classList.contains('show');
  if (isVisible) {
    menuEl.classList.remove('show');
    menuEl.classList.remove('show-above');
    return;
  }

  // ä¸€æ™‚è¡¨ç¤ºã—ã¦é«˜ã•ã‚’è¨ˆæ¸¬
  menuEl.classList.add('show');
  const rect = menuEl.getBoundingClientRect();
  const spaceBelow = window.innerHeight - rect.bottom;
  const spaceAbove = rect.top;

  if (spaceBelow < rect.height && spaceAbove > rect.height) {
    menuEl.classList.add('show-above');
  } else {
    menuEl.classList.remove('show-above');
  }
}


</script>

</div>

<!--
    <form method="GET" action="?">
        <span>ãƒã‚§ãƒƒã‚¯ONã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—</span>

        <form method="GET" action="?">
        <select id="command_option" name="command">
          <option value="1">ã‚³ãƒ¡ãƒ³ãƒˆè¨­å®š</option>
          <option value="2">ç›£è¦–è¨­å®š</option>
        </select>
        </form>


        <span>ã‚’</span>

        <form method="GET" action="?">
        <select id="action_option" name="action">
          <option value="1">è¤‡è£½ã™ã‚‹</option>
          <option value="2">å‰Šé™¤ã™ã‚‹</option>
        </select>
        </form>

      <span>(è¤‡è£½å…ƒï¼š</span>
      <select id="form_xuser" name="xuser">
        <option value="">æœªé¸æŠ</option>
        <?php foreach ($xusers as $k => $row) { ?>
            <option value="<?php echo e($row['id']) ?>" <?php echo ( (string)$row['id'] === (string)$xuser_id ? 'selected' : '' ); ?>><?php echo e($row['name']) ?></option>
        <?php } ?>
      </select>
      <span>)</span>
   </form>
        -->

<div style="margin-top: 20px; font-size: 14px; color: #aaa;">
  <strong>ã‚¢ã‚¤ã‚³ãƒ³å‡¡ä¾‹ï¼š</strong>
  âœ…=é€šå¸¸èªè¨¼ / ğŸï¸=ãƒ¡ãƒ‡ã‚£ã‚¢èªè¨¼ / ğŸ”=ç›£è¦– / ğŸ·ï¸=APIè²¸å‡º / ğŸ¤–=AIï¼ˆè‡ªç”±ï¼‰ / ğŸ‘©=AIï¼ˆè£å¢ï¼‰ / ğŸ“ˆ=AIï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰
</div>
    <table>
<thead>
  <tr>
    <th class="checkbox-col"><input type="checkbox" id="select_all" onclick="toggleSelectAll()"></th>
    <th class="id-col"></th>
    <th class="name-col">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</th>
    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
    <th>æ“ä½œ</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="checkbox-col"><input type="checkbox" name="selected_ids[]" value="<?php echo htmlspecialchars($row['id']); ?>"></td>
    <td class="id-col"></td>
    <td class="name-col">
      <div>
        <div>
          (409)williams_m21427
          <?php echo htmlspecialchars($row['name']); ?>
          <span style="color: #888; font-size: 12px;">[ID=<?php echo htmlspecialchars($row['id']); ?>12]</span>
        </div>
        <div style="font-size: 12px; font-style: italic;">
          <a href="https://x.com/<?php echo urlencode($row['login_id']); ?>"
             target="_blank"
             style="color: #d4af37; text-decoration: none;"
             onmouseover="this.style.textDecoration='underline'"
             onmouseout="this.style.textDecoration='none'">
            @<?php echo htmlspecialchars($row['login_id']); ?>
            williams_m21427
          </a>
        </div>
      </div>
    </td>
<td>
  <?php if (!empty($row['bearer_token']) && !empty($row['refresh_token'])): ?>
    <span title="é€šå¸¸èªè¨¼æ¸ˆã¿">âœ…</span>
  <?php endif; ?>
  <?php if (!empty($row['access_token'])): ?>
    <span title="ãƒ¡ãƒ‡ã‚£ã‚¢èªè¨¼æ¸ˆã¿">ğŸï¸</span>
  <?php endif; ?>
  <?php if (!empty($row['search_enable'])): ?>
    <span title="ç›£è¦–å®Ÿæ–½">ğŸ”</span>
  <?php endif; ?>
  <?php if (isset($row['use_admin_api']) && $row['use_admin_api'] == 1): ?>
    <span title="è²¸å‡ºã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">ğŸ·ï¸</span>
  <?php endif; ?>

</td>    <td>
<div class="dropdown" style="position: relative;">
  <button class="dropdown-button" onclick="toggleMenu(this.nextElementSibling)">æ“ä½œ â–¾</button>
  <div class="dropdown-menu">
    <a href="./account_edit.html" onclick="editAccountMaster(<?= $row['id'] ?>)">ç·¨é›†</a>
    <a href="./comment_list.html" onclick="editComment(<?= $row['id'] ?>)">ï½ºï¾’ï¾ï¾„ä¸€è¦§</a>
    <a href="./comment_regist.html" onclick="registComment(<?= $row['id'] ?>)">ï½ºï¾’ï¾ï¾„ç™»éŒ²</a>
    <?php if (!empty($_SESSION['check_enable'])): ?>
      <a href="./search_list.html" onclick="editCheckAccount(<?= $row['id'] ?>)">è‡ªå‹•ï¾˜ï¾Œï¾Ÿ,ï¾“ï¾‰ï¾ï¾ˆç·¨é›†</a>
    <?php endif; ?>
    <a href="#" onclick="editXLogin2(<?= $row['id'] ?>)">é€šå¸¸èªè¨¼</a>
    <a href="#" onclick="editXLogin1(<?= $row['id'] ?>)">ï¾’ï¾ƒï¾ï½¨ï½±èªè¨¼</a>
    <form class="button_form" method="POST" action="?">
      <input type="hidden" name="type" value="account_del">
      <input type="hidden" name="id" value="<?= htmlspecialchars($row['id']) ?>">
      <button type="submit">å‰Šé™¤</button>
    </form>
  </div>
</div>

    </td>
  </tr>
  <?php endwhile; ?>
</tbody>

</table>

    </div>

    <script>
    // å…¨é¸æŠ/å…¨è§£é™¤æ©Ÿèƒ½
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('input[name="selected_ids[]"]');
        const selectAllCheckbox = document.getElementById('select_all');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }
</script>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function editAccountMaster(id) {
            window.location.href = './account_edit.php?id='+id;
        }

        function editXLogin1(id) {
            window.location.href = './redirect.php?id='+id+'&type=1';
        }

        function editXLogin2(id) {
            window.location.href = './redirect.php?id='+id+'&type=2';
        }


        function deleteUser(button,id) {
            if (confirm("ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID " + id + " ã‚’å‰Šé™¤ã—ã¾ã™ã€‚")) {
                button.form.submit();
            }
        }

        function editComment(id) {
            window.location.href = './comment_list.php?account_id='+id;
        }

        function registComment(id) {
            window.location.href = './comment_regist.php?account_id='+id;
        }

        function editCheckAccount(id) {
            window.location.href = './search_list.php?account_id='+id;
        }
    </script>


    <script>
        $(document).ready(function() {
            $("input[name='new_username']").on("input", function() {
                var username = $(this).val();

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒç©ºã§ãªã„å ´åˆã«ãƒã‚§ãƒƒã‚¯
                if (username) {
                    $.get("./ajax/check_username.php", { username: username }, function(data) {
                        var result = JSON.parse(data);
                        if (result.exists) {
                            alert("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚");
                        }
                    });
                }
            });
        });
    </script>
  </div>
</body>
</html>
